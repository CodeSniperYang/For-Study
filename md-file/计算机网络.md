# 计算机网络-协议

回头来看已经很久没有更新过blog了，一个多月了。
回顾这一个月，几乎一事无成。在端午三天看一看计算机网络的知识并且记录下来，因为之前这方面的一些很简单的东西老是卡我。
这一个月种右2个星期实训，一个星期是关于MFC的，还有的是数据库的。毕竟实训时间很短，MFC只是让我知道了还有这么一个东西，学的并不深入，可以说没有。实训周之前的两个星期简直是废了，好像是在补落下的课程，期间做了一个小手术，现在好的差不多了。
在使用STL的时候十分的不熟练，就在看STL的视频，B站真是一个学习网站。不过还没有看完，STL的学习肯定是要时间久一点的。自己在github上找了一个实现简单STL的小项目，准备看完视频学习学习完去实现一下。
端午三天，那就水水的看一下计算机网络吧，虽然大三下学期会开课，不过我等不及了，老是被卡，很不爽。

---

### 基本信息

计算机网络协议是有关[计算机网络通信](http://baike.sogou.com/lemma/ShowInnerLink.htm?lemmaId=150864)的一整套规则，或者说是为完成计算机网络通信而制订的规则、约定和标准。
网络协议由语法、语义和时序三大要素组成；
{
(1)语法是指通信数据和控制信息的结构与格式；
(2)语义是对具体事件应发出何种控制信息，完成何种动作以及做出何种应答；
(3)时序是对事件实现顺序的详细说明。
}
每种网络协议都有自己的优点，但只有TCP/IP允许与Internet完全的连接。

TCP/IP：Transmission Control Protocol/Internet Protocol的简写，中译名为传输控制协议/因特网互联协议，又叫网络通讯协议，是Internet最基本的协议、Internet国际互联网络的基础，由网络层的IP协议和传输层的TCP协议组成。
通俗而言：TCP负责发现传输的问题，一有问题就发出信号，要求重新传输，直到所有数据安全正确地传输到目的地。而IP是给因特网的每一台联网设备规定一个地址。

互联网、因特网、万维网三者的关系是：互联网包含因特网，因特网包含万维网。凡是能彼此通信的设备组成的网络就叫互联网。所以，即使仅有两台机器，不论用何种技术使其彼此通信，也叫互联网。国际标准的互联网写法是internet，字母i一定要小写！因特网是互联网的一种。因特网可不是仅有两台机器组成的互联网，它是由上千万台设备组成的互联网。因特网使用TCP/IP协议让不同的设备可以彼此通信。但使用TCP/IP协议的网络并不一定是因特网，一个局域网也可以使用TCP/IP协议。判断自己是否接入的是因特网，首先是看自己电脑是否安装了 TCP/IP协议，其次看是否拥有一个公网地址（所谓公网地址，就是所有私网地址以外的地址）。国际标准的因特网写法是Internet，字母I一定要大写！

## 网络协议

#### OSI体系结构

网络分层化(7层)：
物理层，数据链路层，网络层，        (这三层为网络支持层)
传输层，会话层，表示层，应用层    (这四层为用户支持层)

#### TCP\IP体系结构 

分为四层
**应用层** ：应用层，表示层，会话层
包括很多协议：网络传输协议(HTTP)，邮件收发协议(SMTP)，域名系统(DNS)，网络管理协议(SNMP)，文件收发协议(FTP)
**传输层** :传输层
TCP，UDP传输层协议，一个为面向连接，一个面向为连接
**互联层**：网络层
IP协议，ICMP，IJMP，RARP
**主机-网络层**：数据链路层，物理层
ATM协议

#### 应用层协议

**FTP协议**：文件传输协议。FTP进行文件传输时，会启用两条链路，一条链路是**控制连接**，另一条链路是**数据连接**。
FTP的两种**工作模式**：主动模式(Port模式)，被动模式(passive模式)。
主进程接收新请求的**步骤**是：
1、打开服务器端的**21**号端口，使控制连接链路打开；
2、服务器端等待客户进程发出连接请求，客户端打开一个临时的端口，用于进行数据连接；
3、服务器端接收到连接请求并响应，打开**20**号或其他**大于1024**号的端口用于数据连接，并建立起数据连接；**(两种工作模式的区别)**
4、服务器端启动从属进程来处理客户进程发出的请求；
5、从属进程对客户进程处理完毕后，客户端发送关闭连接请求，服务端响应后终止此次文件传输；
6、服务器端回到等待状态，继续接受其他进程发送的请求。

**HTTP协议**：
HTTP (超文本传输协议Hypertext Transfer Protocol) 定义了万维网客户进程(即浏览器)怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。从层次的角度看，HTTP是[应用层协议](http://baike.so.com/doc/6988879-7211731.html)，它是万维网上能够可靠地交换文件(包括[文本](http://baike.so.com/doc/6023706.html)、[声音](http://baike.so.com/doc/2631022-2778106.html)、[图像](http://baike.so.com/doc/4618901.html)等各种多媒体文件)的重要基础。它可以使浏览器更加高效，使网络传输减少，不仅保证计算机正确快速地传输超文本文档，还确定传输文档中的哪一部分，以及哪部分内容首先显示(如文本先于图形)等。HTTP的工作过程可以分为四步：

1、客户给与服务器建立TCP连接。计算机系统中有一个专门为HTTP开放默认端口：[80端口](http://baike.so.com/doc/4557080-4767793.html)，还有一个备用的8080端口，主要用于万维网传输信息的协议。
2、建立连接后，客户机发送一个请求给服务器。请求具有专门的请求格式和请求报文。

![img](http://edu-image.nosdn.127.net/12504D89450A34A1525BCD46C9A93828.png?imageView&thumbnail=890x0&quality=100)

3、服务器接到请求后，给予相应的响应信息。与请求类似，应答也有专门的格式与响应报文。

![img](http://edu-image.nosdn.127.net/0B100F80101BC676BE66D733AF38CA0A.png?imageView&thumbnail=890x0&quality=100)

4、客户端接收服务器所返回的的信息，并通过浏览器显示在用户的显示屏上，此时客户端与服务器端就断开连接。
需要注意的是，如果在上述工作过程中的某异步出现错误，那么产生错误的信息将返回到客户端，并在显示屏上输出。对于用户来说，上述工作过程是HTTP自动完成的，用户只要用鼠标点击，等待信息显示浏览即可。

问：用户在Web浏览器中输入网址：http://www.njau.edu.cn/student/cm/index.htm 后，网页如何传输并显示出来？
1.浏览器分析超链接，超链接中的域名被提取出来，也就是www.njau.edu.cn，通过DNS服务得到对应的IP地址。 
2.浏览器向DNS请求解析www.njau.edu.cn这个域名所对应的IP，得到IP地址后，双方就可以开始建立连接的工作了。
3.双方之间建立起TCP的连接，TCP的传输在80端口或者8080端口完成双方建立起连接后可以进行下一步的工作。 
4.浏览器发出HTTP请求报文，请求报文中包含GET/student/cm/index.htm文件命令，也就是请求得到student文件夹下cm文件夹下index.htm这个文件，服务器收到请求报文后，会按照这个路径到对应的文件夹下取得对应的文件，把它组织到报文当中，反馈给浏览器，浏览器接受后会检查报文是否完整，随后TCP连接被释放。 
5.协议在浏览器这端对响应报文进行一个文件提取的工作，它会将传过来的文件按照超文本的格式在屏幕上显示出来，用户这时就能看到网页的全部内容了。

### 传输层协议

传输层作用：组包，来连接控制，寻址，提供可靠性服务。
应用层的数据通过端口到达传输层。
下面两种都为**进程到进程的传输**

#### TCP

面向连接，传输控制协议。
TCP具有6个特点：面向连接的传输；端到端的通信；高可靠性，确保传输数据的正确性，不出现丢失或乱序；全双工方式传输；采用字节流方式，即以字节为单位传输字节序列；紧急数据传送功能。 
**TCP报文和TCP首部结构：**
TCP数据被封装在一个IP数据报中，传送的数据单位协议是 TCP 报文段。TCP报文段包含TCP首部和TCP数据部分。为了保证可靠性，发送的报文都有递增的序列号。序号和确认号用来确保传输的可靠性。此外，对每个报文都设立一个定时器，设定一个最大时延。对那些超过最大时延仍没有收到确认信息的报文就认为已经丢失，需要重传。TCP首部的结构如下：

![img](http://edu-image.nosdn.127.net/D8D83E68901237D3BD509818196AE638.png?imageView&thumbnail=890x0&quality=100)



**◇** 源端口和目的端口：各占2字节。端口是传输层与应用层的服务接口，传输层的复用和分用功能都要通过端口才能实现。

**◇** 序号：占4字节。TCP连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。

**◇** 确认号：占4字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。

**◇** 数据偏移：占4位，它指出 TCP报文段的数据起始处距离TCP报文段的起始处有多远。“数据偏移”的单位是32位字(以4字节为计算单位)。

**◇** 保留：占6位，保留为今后使用，但目前应置为0。

**◇** 紧急URG：当URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。

**◇** 确认ACK：只有当ACK=1时确认号字段才有效。ACK=0时，确认号无效。

**◇** 推送PSH：当TCP收到PSH = 1的报文段,就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。

**◇** 复位RST ：当RST=1时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。

**◇** 同步SYN：SYN = 1表示这是一个连接请求或连接接受报文。

**◇** 终止 FIN：用来释放一个连接。FIN=1表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。

**◇** 检验和：占 2 字节。检验和字段检验的范围包括首部和数据这两部分，在计算检验和时，要在 TCP 报文段的前面加上12字节的伪首部。

**◇** 紧急指针：占 16 位。指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。

**◇** 选项：长度可变。TCP最初只规定了一种选项，即 MSS(最大报文段长度Maximum Segment Size)。MSS 告诉对方 TCP：“我的缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节。” MSS是 TCP 报文段中的数据字段的最大长度，数据字段加上TCP首部才等于整个的TCP报文段。

**◇** 填充：为了使整个首部长度是 4 字节的整数倍。

**◇** 窗口：占 2 字节。窗口字段用来控制对方发送的数据量，单位为字节。TCP 连接的一端根据设置的缓存空间大小确定自己的接收窗口大小，然后通知对方以确定对方的发送窗口的上限。

**TCP协议的三个工作过程：**TCP协议的工作经历三个阶段：连接建立，数据传输，连接释放。

1、连接建立：建立一个连接需要三次握手。

![img](http://edu-image.nosdn.127.net/C46AD973FB0B40B07624262CF1345FD5.png?imageView&thumbnail=890x0&quality=100)

A向B发出连接请求报文段，其首部中的同步位SYN = 1，并选择序号seq = x，表明传送数据时的第一个数据字节的序号是x；

B收到连接请求报文段后，如果同意，则发回确认，使 SYN = 1，ACK = 1，确认号ack = x﹢1，选择的序号 seq = y；

A收到此报文段后向B给出确认，其 ACK = 1，确认号ack = y﹢1，并通知上层应用进程，连接已经建立。B收到主机 A 的确认后，也通知其上层应用进程TCP连接已经建立。

2、数据传输：连接建立后即可进行数据传输。

3、连接释放：终止一个连接要经过四次握手。

![img](http://edu-image.nosdn.127.net/B402DBEFE8BF51003BA8EE13192F953D.png?imageView&thumbnail=890x0&quality=100)



数据传输结束后，通信的双方都可释放连接。例如：A的应用进程先发出连接释放报文段，并停止再发送数据，主动关闭TCP连接。A 把连接释放报文段首部的FIN = 1,其序号seq = u，等待B的确认。

B发出确认，确认号ack = u＋1，而这个报文段自己的序号seq =v。TCP服务器进程通知高层应用进程，从A到B这个方向的连接就释放了，TCP 连接处于半关闭状态。若B 发送数据，A仍要接收。

若B已经没有要向A发送的数据，其应用进程就通知TCP释放连接。

A收到连接释放报文段后，必须发出确认，在确认报文段中ACK = 1，确认号ack=w﹢1，序号seq = u + 1。

TCP连接必须经过时间2MSL后才真正释放掉，2MSL的时间是 为了保证 A 发送的最后一个ACK报文段能够到达B。防止“已失效的连接请求报文段”出现在本连接中。A 在发送完最后一个ACK报文段后，再经过时间2MSL，就可以使本连接持续的时间内所产生的所有报文段，都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。

---

#### UDP

用户数据报协议，当数据很大时传输，当网络服务和网络设备接触很紧密的时候使用。
速度很快，负载很小。
最大**特点**：不提供数据包分组，组装，以及对数据进行排序。
UDP具有以下几个**特点**：
1、是无连接的。相比于TCP协议，UDP协议在传送数据前不需要建立连接，当然也就没有释放连接，这就使得UDP的传输效率高。
2、是尽最大努力交付的。UDP协议无法保证数据能够准确的交付到目的主机，也不需要对接收到的UDP报文进行确认。
3、是面向报文的。UDP协议将应用层传输下来的数据封装在一个UDP包中，不进行拆分或合并。运输层在收到对方的UDP包后，会去掉首部后，将数据原封不动的交给应用进程。
4、没有拥塞控制。UDP协议的发送速率不受网络的拥塞度影响。
5、UDP支持一对一、一对多、多对一和多对多的交互通信。
6、UDP的头部占用较小，只占用8个字节。
7、UDP设计简单，保证了UDP在工作时的高效性和低延时性。
正是这些特点，UDP通常被用于输延时小，对可靠性要求不高，有少量数据要进行传输的情况，如DNS(域名服务)、TFTP(简单文件传输)、SNMP（简单网络管理协议、语音和视频等)

---

### 网际层 IP

应用层和传输层被称为上层，主要和软件，进程打交道
IP提供不可靠的，无连接的数据传送服务。
**不可靠**指它不能保证IP数据报能成功到达目的地。IP仅提供最好的传输服务。当发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息给信源。任何要求的可靠性必须由上层来提供。
**无连接**指IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B）每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。 

**MTU**
链路层具有**最大传输单元**MTU这个特性，它限制了数据帧的最大长度，不同的网络类型都有一个上限值。如果网络层有数据包要传，而且数据包的长度超过了MTU，那么网络层就要对数据包进行**分片**操作，使每一片的长度都小于或等于MTU。一个分片在到达接收主机的路径中，还可能被继续分片，因此，分片的IP数据报可能会以不同的路径传输到接收主机，接收主机通过一系列的**重组**，将其还原为一个完整的IP数据报，再提交给上层协议处理。

![img](http://edu-image.nosdn.127.net/F8BBF44C242AF381310293B72160C825.png?imageView&thumbnail=890x0&quality=100)

**IP协议的分片和重组：**
当提交给数据链路层进行传送时，一个IP分片或一个很小的无需分片的IP数据报称为**分组**。数据链路层在分组前面加上它自己的首部，并发送得到的帧。

IP首部(5-8字节)包含了分片和重组所需的信息：

![img](http://edu-image.nosdn.127.net/AEDEE8E2DD3904A8C97DFC2438ECAA9A.png?imageView&thumbnail=890x0&quality=100)

**Identification**：发送端发送的IP数据包标识字段都是一个唯一值，该值在分片时被复制到每个片中。
**R**：保留未用。
**DF**：“不分片”位，如果将这一比特置1，IP层将不对数据报进行分片。
**MF**：“更多的片”，除了最后一片外，其他每个组成数据报的片都要把该比特置1。
**FragmentOffset**：该片偏移原始数据包开始处的位置。偏移的字节数是该值乘以8。

两个Flags和Fragment Offset结合使用，进行分片时，DF比特设置为0，表示可以进行分片，这时如果 MF的值为1，则表示当前IP报文是一个IP包的其中一段分片，并且不是最后一个分片，这时结合Fragment Offset域继续判断；如果MF为1而 Fragment Offset= 0，表示该IP报文为第一个分片，而且后续有分片；如果MF为1而Fragment Offset不是0，表示该IP报文为中间的一个分片；如果MF为0而Fragment Offset不是0，表示该报文是最后一个分片。另外，当数据报被分片后，每个片的总长度值要改为该片的长度值。

**IP**

![img](http://edu-image.nosdn.127.net/74B229911BD781CDCBA587931D0F5359.png?imageView&thumbnail=890x0&quality=100)



IP寻路要经过以下几个步骤：
1、搜索路由表中目的地址域与分组地址完全相同的入口，如果找到这样的入口，则将分组发给下一个路由器地址中指定的地址(下一个路由器或直连网络接口)。
2、如果1不成功，则搜索路由表中目的地址域与分组的目的网络地址相同的入口，如果能到则将分组发给下一个路由器地址域中指定的地址。
3、如果2不成功，则搜索路由表中目的地址域为“default”的入口，如果找到就将分组发给指定的路由器。
4、如果3仍不成功，则说明分组不可投递，通常将“主机不可达”或“网络不可答”的信息发送给产生这个分组的应用程序。

---

### 网络接口层协议ATM

异步传输模式，高速的分组交换技术。数据传送的单元叫做信元，对不同的数据进行不同的封装。ATM(Asynchronous Transfer Mode)是一种以**信元**为单位的**异步传输模式**（又被译为异步转移模式或异步传送模式）。它是基于B-ISDN宽带综合服务数字网标准而设计的用来提高用户综合访问速度的一项技术。在交换形式上而言，ATM 是**面向连接的链路**，任何一个 ATM 终端与另一个用户通信的时候都需要建立连接，所以，ATM 拥有**电路交换**的特点；在ATM交换方式中，文本、语音、视频等所有数据将被分解为长度固定的信元（cell）。信元长度固定为**53**字节。

![img](http://p.ananas.chaoxing.com/star3/origin/56ea17f1e4b0b07fe6d024b5.png)

ATM的网络模型如上所示，包含两个重要部分：UNI和NNI。

**① UNI（用户-网络接口）：**UNI为ATM网中的用户网络接口，它是用户设备与网络之间的接口，直接面向用户。按其所在位置不同又可分为公用网UNI和专用网UNI（P-UNI），PUNI不必象公网接口考虑严格的一致性，因而PUNI接口形式更多、更灵活。

**② NNI（网络节点接口）：**一般为两个交换机之间的接口，同样也分为公网NNI（和专用网NNI（PNNI）。公网NNI和PNNI的差别很大，如公网NNI的信令为No.7信令体系的宽带ISDN用户部分（BISUP），而PNNI则完全基于UNI接口，仍采用UNI信令结构。



**ATM信元**

![img](http://p.ananas.chaoxing.com/star3/origin/56ea1802e4b0b07fe6d024cf.png)

ATM是一种高速分组交换技术。分组交换的基本数据传输单元是分组，而ATM的基本数据传输单元是信元。在ATM交换方式中，文本、语音、视频等所有数据将被分解为长度固定的信元（cell）。信元有一个5字节的信元头（header）与一个48字节的用户数据（user data），信元长度为53字节。

![img](http://p.ananas.chaoxing.com/star3/origin/56ea1812e4b0b07fe6d024e8.png)



**GFC：一般流量控制**
**VPI ：虚通道标识
VCI ：虚信道标识
PTI ：净荷类型
CLP：-信元丢失优先级
HEC：信头误码控制**



**信元交换过程**

![img](http://p.ananas.chaoxing.com/star3/origin/56ea186ae4b0b07fe6d0254f.png)

物理链路是连接ATM交换机-ATM交换机、ATM交换机-ATM主机的物理线路。每条物理链路可以包含一条或多条虚通路VP，每条虚通路VP又可以包含一条或多条虚通道VC。

VP：在虚通路一级，两个ATM端用户间建立的连接被称为虚通路连接，而两个ATM设备间的链路被称为虚通路链路（VPL，virtual path link）。那么，一条虚通路连接是由多段虚通路链路组成的。每一段虚通路链路VPL都是由虚通路标识符（VPI，virtual path identifier）标识的。每条物理链路中的VPI值是惟一的。虚通路可以是永久的，也可以是交换式的。每条虚通路中可以有单向或双向的数据流，ATM支持不对称的数据速率，即允许两个方向的数据速率可以是不同的。

VC：在虚通道一级，两个ATM端用户间建立的连接被称为虚通道连接，而两个ATM设备间的链路称为虚通道链路（VCL，virtual channel link）。虚通道连接VCC是由多条虚通道链路VCL组成的。每一条虚通道链路VCL都是用虚通道标识符（VCI，virtual channel identifier）来标识的。根据虚通道建立方式的不同，虚通道又可分为以下两类：永久虚通道（PVC，permanentvirtual channel）、交换虚通道（SVC，switched virtual channel）。虚通道中的数据流可以是单向的，也可以是双向的。当虚通道双向传输信元时，两个方向的通信参数可以是不相同的。

![img](http://p.ananas.chaoxing.com/star3/origin/56ea1878e4b0b07fe6d0255f.png)



ATM交换的本质上是分组交换，ATM交换又分为VP交换和VC交换两种，VPI和VCI只在两个物理节点之间有意义。

![img](http://p.ananas.chaoxing.com/star3/origin/56ea1883e4b0b07fe6d02569.png)

> **【VP交换只改变VPI的值不改变VCI的值；VC交换既改变VPI的值又改变VCI的值】**



---

以上材料大多来源于
中国大学慕课MOOC---计算机网络课(南京农业大学)http://www.icourse163.org/learn/NJAU-1001752039?tid=1450225473